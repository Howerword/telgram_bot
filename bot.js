require('dotenv').config(); // –ü—ñ–¥–∫–ª—é—á–∞—î–º–æ –∑–º—ñ–Ω–Ω—ñ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞
const { Telegraf, Markup } = require('telegraf'); // –Ü–º–ø–æ—Ä—Ç—É—î–º–æ Telegraf
const db = require('./database'); // –ü—ñ–¥–∫–ª—é—á–∞—î–º–æ –±–∞–∑—É –¥–∞–Ω–∏—Ö

const bot = new Telegraf(process.env.BOT_TOKEN); // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ –±–æ—Ç–∞

// –ì–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é –∑ –∫–Ω–æ–ø–∫–∞–º–∏
const mainMenu = Markup.keyboard([
    ['üìÖ –ù–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ –Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è'],
    ['üîò –ö–Ω–æ–ø–∫–∞ 1', 'üîò –ö–Ω–æ–ø–∫–∞ 2'],
    ['üîò –ö–Ω–æ–ø–∫–∞ 3', 'üîò –ö–Ω–æ–ø–∫–∞ 4']
]).resize(); // –†–æ–±–∏–º–æ –∫–Ω–æ–ø–∫–∏ –∞–¥–∞–ø—Ç–∏–≤–Ω–∏–º–∏

// –ö–Ω–æ–ø–∫–∏ –≤–∏–±–æ—Ä—É —Ö–≤–∏–ª–∏–Ω –¥–ª—è –Ω–∞–≥–∞–¥—É–≤–∞–Ω—å
const reminderTimes = [30, 35, 40, 45];
const reminderMenu = Markup.inlineKeyboard(
    reminderTimes.map((time) => Markup.button.callback(`${time} —Ö–≤`, `set_reminder_${time}`)),
    { columns: 2 }
);

// –û–±—Ä–æ–±–Ω–∏–∫ –∫–æ–º–∞–Ω–¥–∏ /start
bot.start(async (ctx) => {
    const userId = ctx.from.id;
    try {
        const savedTime = await db.getReminderTime(userId); // –û—Ç—Ä–∏–º—É—î–º–æ –∑–±–µ—Ä–µ–∂–µ–Ω–∏–π —á–∞—Å
        let message = '–ü—Ä–∏–≤—ñ—Ç! –¶–µ —Ç–µ—Å—Ç–æ–≤—ñ –∫–Ω–æ–ø–∫–∏:';
        if (savedTime) {
            message += `\nüîî –í–∞—à –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–π —á–∞—Å –Ω–∞–≥–∞–¥—É–≤–∞–Ω—å: ${savedTime} —Ö–≤`;
        }
        ctx.reply(message, mainMenu);
    } catch (err) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —á–∞—Å—É –Ω–∞–≥–∞–¥—É–≤–∞–Ω—å:', err);
        ctx.reply('–ü—Ä–∏–≤—ñ—Ç! –¶–µ —Ç–µ—Å—Ç–æ–≤—ñ –∫–Ω–æ–ø–∫–∏:', mainMenu);
    }
});

// –û–±—Ä–æ–±–∫–∞ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è "üìÖ –ù–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ –Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è"
bot.hears('üìÖ –ù–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ –Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è', (ctx) => {
    ctx.reply('–û–±–µ—Ä—ñ—Ç—å, –Ω–∞ —Å–∫—ñ–ª—å–∫–∏ —Ö–≤–∏–ª–∏–Ω –ø—ñ—Å–ª—è –∫–æ–∂–Ω–æ—ó –≥–æ–¥–∏–Ω–∏ —Ö–æ—á–µ—Ç–µ –æ—Ç—Ä–∏–º—É–≤–∞—Ç–∏ –Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è:', reminderMenu);
});

// –û–±—Ä–æ–±–∫–∞ –≤–∏–±–æ—Ä—É —á–∞—Å—É –Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è
bot.action(/^set_reminder_\d+$/, async (ctx) => {
    const userId = ctx.from.id;
    const selectedTime = parseInt(ctx.match[0].split('_')[2]);
    try {
        await db.setReminderTime(userId, selectedTime); // –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è —É –±–∞–∑—ñ
        ctx.reply(`‚úÖ –ù–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞ ${selectedTime} —Ö–≤–∏–ª–∏–Ω –ø—ñ—Å–ª—è –∫–æ–∂–Ω–æ—ó –≥–æ–¥–∏–Ω–∏.`);
    } catch (err) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —á–∞—Å—É –Ω–∞–≥–∞–¥—É–≤–∞–Ω—å:', err);
        ctx.reply('‚ùå –ü–æ–º–∏–ª–∫–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.');
    }
});

// –ó–∞–ø—É—Å–∫–∞—î–º–æ –±–æ—Ç–∞
bot.launch();
console.log('–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω–æ!');
